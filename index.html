<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="BalanceChain Bio-Vault: Pegged, stable, audit-proof digital money. 1 TVM = 12 SHE = 1 USD. Powered by human effort.">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://worldtimeapi.org; style-src 'self' https://cdn.tailwindcss.com; connect-src 'self' https://worldtimeapi.org; img-src 'self' data:;">
  <title>Bio-Vault | BalanceChain | TVM</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    html, body {
      background: linear-gradient(to left, #2f4979, #15264d);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      scroll-behavior: smooth;
    }
    .hidden { display: none !important; }
    .modal, .popup {
      background: rgba(0,0,0,0.82);
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10010;
      display: none; justify-content: center; align-items: center; flex-direction: column;
      animation: fadeIn 0.22s;
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
    .modal-content, .popup-content {
      background: #fff; color: #0e2242; padding: 32px 22px; border-radius: 11px;
      max-width: 440px; min-width: 260px; box-shadow: 0 8px 44px rgba(0,0,0,0.25);
      text-align: left; font-size: 17px; line-height: 1.6; animation: scaleIn 0.18s;
    }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.91); } to { opacity: 1; transform: scale(1); } }
    .modal-close {
      position: absolute; top: 11px; right: 16px; background: none; border: none;
      color: #174ca7; font-size: 25px; cursor: pointer; z-index: 2;
    }
    .modal-nav {
      display: flex; gap: 6px; margin-bottom: 18px; justify-content: center; flex-wrap: wrap;
    }
    .modal-nav button {
      background: #e9edfc; color: #1a3167; padding: 5px 13px; border-radius: 5px;
      border: none; margin: 0; font-size: 15px; font-weight: bold; transition: background 0.22s;
    }
    .modal-nav button.active, .modal-nav button:hover { background: #ffe164; color: #193356; }
    .modal-tip {
      color: #08b0a4; background: #f3f4f6; padding: 7px 12px; border-radius: 5px;
      display: inline-block; margin: 9px 0; font-size: 0.96rem;
    }
    .toast {
      position: fixed; bottom: 38px; left: 50%; transform: translateX(-50%);
      background: #10b981; color: #fff; font-weight: bold; border-radius: 7px;
      padding: 15px 30px; z-index: 10070; font-size: 17px; min-width: 170px;
      text-align: center; box-shadow: 0 4px 24px rgba(0,0,0,0.3); animation: fadeIn 0.27s;
      display: none;
    }
    .toast-error { background: #ef4444; }
    .tooltip {
      position: relative; display: inline-block;
    }
    .tooltip .tooltip-text {
      visibility: hidden; width: 200px; background: #1a2d50; color: #fff;
      text-align: center; border-radius: 6px; padding: 5px; position: absolute;
      z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%);
      opacity: 0; transition: opacity 0.3s;
    }
    .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
    #transactionTable { width: 100%; border-collapse: collapse; background: #fff; color: #000; border-radius: 5px; }
    #transactionTable th, #transactionTable td { padding: 10px; border-bottom: 1px solid #ccc; }
    #transactionTable th { background: #f3f4f6; }
    @media (max-width: 768px) {
      #transactionTable th:nth-child(2), #transactionTable td:nth-child(2) { max-width: 60px; word-wrap: break-word; }
      .modal-content, .popup-content { padding: 12px; font-size: 15px; }
    }
    @media (max-width: 480px) {
      #transactionTable { font-size: 12px; }
      .modal-nav { flex-direction: column; }
      .toast { padding: 9px 8vw; font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }
  </script>

  <!-- Explainer Section -->
  <section class="explainer-section max-w-4xl mx-auto bg-white bg-opacity-10 p-6 rounded-lg shadow-lg" id="explainer">
    <h2 class="text-2xl font-bold text-yellow-300">BalanceChain: Digital Money Redefined</h2>
    <p class="mt-2"><b>1 TVM = 12 SHE = 1 USD. Pegged, stable, audit-proof. Powered by human effort.</b></p>
    <div class="explainer-features flex flex-wrap gap-3 mt-4">
      <div class="explainer-feature bg-gray-800 text-yellow-300 rounded-lg p-3 flex-1 min-w-[120px]">Pegged & Stable</div>
      <div class="explainer-feature bg-gray-800 text-yellow-300 rounded-lg p-3 flex-1 min-w-[120px]">Audit-Proof</div>
      <div class="explainer-feature bg-gray-800 text-yellow-300 rounded-lg p-3 flex-1 min-w-[120px]">Human-Effort Backed</div>
      <div class="explainer-feature bg-gray-800 text-yellow-300 rounded-lg p-3 flex-1 min-w-[120px]">P2P & Private</div>
    </div>
    <div class="explainer-links flex flex-wrap gap-2 mt-4">
      <button class="underline" onclick="openModal('whitepaperModal')">White Paper</button>
      <button class="underline" onclick="openModal('faqModal')">FAQ</button>
      <button class="underline" onclick="openModal('supportModal')">Support</button>
      <button class="underline" onclick="openModal('communityModal')">Community</button>
      <button class="underline" onclick="openModal('legalModal')">Legal</button>
      <button class="audit-btn border-2 border-yellow-300 text-yellow-300 rounded-lg px-3 py-1" onclick="openModal('auditModal')">Audit Peg</button>
    </div>
    <div class="onboarding-tip bg-gray-900 text-teal-300 p-3 rounded-lg mt-4" id="onboardingTip" style="display:none">
      <b>Tip:</b> Back up your vault now. Loss of backup or passphrase means permanent fund loss.
    </div>
  </section>

  <!-- Help FAB -->
  <button class="help-fab bg-yellow-300 text-gray-800 rounded-full w-14 h-14 shadow-lg text-2xl font-bold" title="Get Help" aria-label="Help" onclick="openModal('faqModal')">?</button>

  <!-- Onboarding Modal -->
  <div id="onboardingModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('onboardingModal')">×</button>
      <div class="modal-nav">
        <button class="active" onclick="modalNav('onboardingModal',0)">Welcome</button>
        <button onclick="modalNav('onboardingModal',1)">How It Works</button>
        <button onclick="modalNav('onboardingModal',2)">Security</button>
      </div>
      <div class="modal-onboarding-page">
        <h2 class="text-blue-600">Welcome to Bio-Vault</h2>
        <p>World’s first fair, pegged, audit-proof digital money system. 1 TVM = 12 SHE = 1 USD.</p>
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-4" onclick="modalNav('onboardingModal',1)">Next →</button>
      </div>
      <div class="modal-onboarding-page hidden">
        <h2 class="text-blue-600">How It Works</h2>
        <ul class="modal-list list-disc pl-5">
          <li>Create vault: Local, private keys and proofs.</li>
          <li>Transfer TVM instantly, no middlemen.</li>
          <li>1 TVM = 12 SHE = 1 USD. Always auditable.</li>
          <li>Bridge to blockchain via TVM contract.</li>
        </ul>
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-4" onclick="modalNav('onboardingModal',2)">Next →</button>
      </div>
      <div class="modal-onboarding-page hidden">
        <h2 class="text-blue-600">Security First</h2>
        <ul class="modal-list list-disc pl-5">
          <li><b>Backup now.</b> Passphrase + file = your money.</li>
          <li>No recovery without backup. Your keys, your responsibility.</li>
          <li>Store backups securely. Never share passphrase.</li>
        </ul>
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-4" onclick="closeModal('onboardingModal')">Got it</button>
      </div>
    </div>
  </div>

  <!-- White Paper Modal -->
  <div id="whitepaperModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('whitepaperModal')">×</button>
      <div class="modal-nav">
        <button class="active" onclick="openModal('whitepaperModal')">White Paper</button>
        <button onclick="openModal('faqModal')">FAQ</button>
        <button onclick="openModal('auditModal')">Audit Peg</button>
        <button onclick="openModal('supportModal')">Support</button>
        <button onclick="openModal('communityModal')">Community</button>
        <button onclick="openModal('legalModal')">Legal</button>
      </div>
      <h2 class="text-blue-600">BalanceChain White Paper</h2>
      <p>1 TVM = 12 SHE = 1 USD, pegged to human effort (SHE: Standard Human Effort, 1 min). Derived from 100-year GDP/capita ($10,000/year, 2000 hours).</p>
      <div class="modal-features flex flex-wrap gap-2">
        <div class="modal-feature bg-gray-800 text-yellow-300 rounded-lg p-2">Pegged 1 TVM = 1 USD</div>
        <div class="modal-feature bg-gray-800 text-yellow-300 rounded-lg p-2">Human-Effort Backed</div>
        <div class="modal-feature bg-gray-800 text-yellow-300 rounded-lg p-2">Audit-Proof</div>
      </div>
      <ul class="modal-list list-disc pl-5">
        <li>TVM: Pegged, redeemable 1:1 for USD value.</li>
        <li>Every TVM backed by cryptographic SHE proof.</li>
        <li>No mining, no inflation—just real value.</li>
        <li>Offline, self-custodial, instantly auditable.</li>
      </ul>
      <div class="modal-tip">Full white paper: <a href="mailto:support@shemoney.app" class="text-blue-600">Contact support</a>.</div>
    </div>
  </div>

  <!-- Audit Modal -->
  <div id="auditModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('auditModal')">×</button>
      <div class="modal-nav">
        <button onclick="openModal('whitepaperModal')">White Paper</button>
        <button onclick="openModal('faqModal')">FAQ</button>
        <button class="active" onclick="openModal('auditModal')">Audit Peg</button>
        <button onclick="openModal('supportModal')">Support</button>
        <button onclick="openModal('communityModal')">Community</button>
        <button onclick="openModal('legalModal')">Legal</button>
      </div>
      <h2 class="text-blue-600">Audit the Peg</h2>
      <p><b>1 TVM = 1 USD:</b> Enforced by protocol and smart contract. No inflation possible.<br>
      <span id="auditPegLive">Loading peg status...</span><br>
      Download audit logs or compliance reports anytime.</p>
      <button id="exportComplianceBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-4">Export Compliance Report</button>
      <div class="modal-tip">Peg is code-enforced. No one can break it.</div>
    </div>
  </div>

  <!-- FAQ Modal -->
  <div id="faqModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('faqModal')">×</button>
      <div class="modal-nav">
        <button onclick="openModal('whitepaperModal')">White Paper</button>
        <button class="active" onclick="openModal('faqModal')">FAQ</button>
        <button onclick="openModal('auditModal')">Audit Peg</button>
        <button onclick="openModal('supportModal')">Support</button>
        <button onclick="openModal('communityModal')">Community</button>
        <button onclick="openModal('legalModal')">Legal</button>
      </div>
      <h2 class="text-blue-600">FAQ</h2>
      <ul class="modal-list list-disc pl-5">
        <li><b>Why 1 TVM = 1 USD?</b> Pegged via SHE (12 min = 1 USD).</li>
        <li><b>What is Bio-IBAN?</b> Unique, private vault identifier.</li>
        <li><b>What is Bio-Catch?</b> Cryptographic transfer proof.</li>
        <li><b>Lose my vault?</b> Funds are gone without backup.</li>
        <li><b>Blockchain use?</b> Connect wallet for TVM claims.</li>
        <li><b>Privacy?</b> Local keys, no public data unless on-chain.</li>
      </ul>
    </div>
  </div>

  <!-- Support Modal -->
  <div id="supportModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('supportModal')">×</button>
      <div class="modal-nav">
        <button onclick="openModal('whitepaperModal')">White Paper</button>
        <button onclick="openModal('faqModal')">FAQ</button>
        <button onclick="openModal('auditModal')">Audit Peg</button>
        <button class="active" onclick="openModal('supportModal')">Support</button>
        <button onclick="openModal('communityModal')">Community</button>
        <button onclick="openModal('legalModal')">Legal</button>
      </div>
      <h2 class="text-blue-600">Support</h2>
      <p>Contact us:<br>
      <b>Email:</b> <a href="mailto:support@shemoney.app" class="text-blue-600" rel="noopener">support@shemoney.app</a><br>
      <b>Telegram:</b> <a href="https://t.me/yourcommunity" target="_blank" class="text-blue-600" rel="noopener">@yourcommunity</a></p>
    </div>
  </div>

  <!-- Community Modal -->
  <div id="communityModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('communityModal')">×</button>
      <div class="modal-nav">
        <button onclick="openModal('whitepaperModal')">White Paper</button>
        <button onclick="openModal('faqModal')">FAQ</button>
        <button onclick="openModal('auditModal')">Audit Peg</button>
        <button onclick="openModal('supportModal')">Support</button>
        <button class="active" onclick="openModal('communityModal')">Community</button>
        <button onclick="openModal('legalModal')">Legal</button>
      </div>
      <h2 class="text-blue-600">Community</h2>
      <p>Join us:<br>
      <b>Telegram:</b> <a href="https://t.me/yourcommunity" target="_blank" class="text-blue-600" rel="noopener">@yourcommunity</a><br>
      <b>Discord:</b> <a href="https://discord.gg/yourserver" target="_blank" class="text-blue-600" rel="noopener">discord.gg/yourserver</a></p>
    </div>
  </div>

  <!-- Legal Modal -->
  <div id="legalModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" tabindex="0">
      <button class="modal-close" aria-label="Close" onclick="closeModal('legalModal')">×</button>
      <div class="modal-nav">
        <button onclick="openModal('whitepaperModal')">White Paper</button>
        <button onclick="openModal('faqModal')">FAQ</button>
        <button onclick="openModal('auditModal')">Audit Peg</button>
        <button onclick="openModal('supportModal')">Support</button>
        <button onclick="openModal('communityModal')">Community</button>
        <button class="active" onclick="openModal('legalModal')">Legal</button>
      </div>
      <h2 class="text-blue-600">Legal & Privacy</h2>
      <p><b>Terms:</b> Experimental, open-source. Users are responsible for funds and backups.<br>
      <b>Privacy:</b> GDPR/CCPA-compliant. No PII collected; all data stays local unless exported.</p>
    </div>
  </div>

  <!-- Passphrase Modal -->
  <div id="passModal" class="popup" aria-modal="true" role="dialog">
    <div class="popup-content">
      <h3 id="passModalTitle" class="text-blue-600">Enter Passphrase</h3>
      <label for="passModalInput">Passphrase:</label><br>
      <input type="password" id="passModalInput" class="input-field w-full p-2 rounded-lg" placeholder="Enter passphrase" aria-label="Passphrase">
      <label for="passModalConfirmInput" id="passModalConfirmLabel" class="hidden">Confirm Passphrase:</label><br>
      <input type="password" id="passModalConfirmInput" class="input-field w-full p-2 rounded-lg hidden" placeholder="Confirm passphrase" aria-label="Confirm Passphrase">
      <button id="passModalCancelBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg mt-2">Cancel</button>
      <button id="passModalSaveBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-2">Save</button>
    </div>
  </div>

  <!-- Bio-Catch Popup -->
  <div id="bioCatchPopup" class="popup" aria-modal="true" role="dialog">
    <div class="popup-content">
      <h3 class="text-blue-600">Your Bio-Catch</h3>
      <p id="bioCatchNumberText" data-full-catch=""></p>
      <canvas id="qrCodeCanvas" class="my-4 mx-auto"></canvas>
      <p id="bioCatchSize" class="text-sm text-gray-600">Size: Calculating...</p>
      <button id="copyBioCatchBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Copy Bio-Catch</button>
      <button id="closeBioCatchPopup" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Close</button>
    </div>
  </div>

  <!-- Locked Screen -->
  <main id="lockedScreen" class="text-center mt-12">
    <h1 class="text-4xl font-bold">Bio-Vault</h1>
    <h2 class="text-xl mt-4">Your Pegged, Audit-Proof Digital Money</h2>
    <div class="tooltip">
      <button id="enterVaultBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg mt-6" aria-label="Enter Vault">Enter Vault</button>
      <span class="tooltip-text">Unlock or create your vault with biometric authentication.</span>
    </div>
  </main>

  <!-- Vault UI -->
  <main id="vaultUI" class="hidden max-w-4xl mx-auto">
    <!-- Vault Controls -->
    <section class="flex justify-between mb-4">
      <button id="lockVaultBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg" aria-label="Lock Vault">Lock Vault</button>
      <button id="terminateBtn" class="bg-red-800 text-white px-4 py-2 rounded-lg" aria-label="Terminate Vault">Terminate Vault</button>
      <button id="testModeBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg" aria-label="Toggle Test Mode">Test Mode</button>
    </section>

    <!-- Bio-IBAN -->
    <section class="section bg-white bg-opacity-10 p-4 rounded-lg">
      <label for="bioibanInput" class="text-lg">Your Bio-IBAN:</label><br>
      <div class="tooltip">
        <input type="text" id="bioibanInput" class="input-field w-full p-2 rounded-lg" readonly aria-label="Bio-IBAN">
        <span class="tooltip-text">Your unique, hashed vault identifier. Private and secure.</span>
      </div>
      <button id="copyBioIBANBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Copy Bio-IBAN">Copy</button>
    </section>

    <!-- Balances -->
    <section id="balanceContainer" class="section bg-white bg-opacity-10 p-4 rounded-lg">
      <div class="tooltip">
        <span id="tvmBalance" class="text-lg">Balance: 0 TVM</span><br>
        <span id="usdBalance" class="text-lg">Equivalent: 0 USD</span><br>
        <span id="segmentStatus" class="text-sm">Segments: 0/12000 Unlocked</span><br>
        <span id="tvmClaimable" class="text-sm">TVM Claimable: 0</span>
        <span class="tooltip-text">12,000 segments/year, 1,200 initially unlocked. Caps: 3/day, 30/month, 90/year. 1 TVM = 12 SHE = 1 USD.</span>
      </div>
    </section>

    <!-- Bio-Constant & UTC -->
    <section id="bioLineUTCContainer" class="section bg-white bg-opacity-10 p-4 rounded-lg flex justify-between flex-wrap">
      <div id="bioLineText" class="text-lg">🔄 Bio-Constant: 0</div>
      <div id="utcTime" class="text-lg">UTC: Loading...</div>
    </section>

    <!-- Wallet & TVM Claim -->
    <section class="section bg-white bg-opacity-10 p-4 rounded-lg">
      <label for="userWalletAddress" class="text-lg">KYC’d Wallet Address:</label><br>
      <div class="tooltip">
        <input type="text" id="userWalletAddress" class="input-field w-full p-2 rounded-lg" placeholder="0x..." aria-label="Wallet Address">
        <span class="tooltip-text">KYC’d wallet required for TVM claims (12 segments = 1 TVM).</span>
      </div>
      <button id="saveWalletBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Save Wallet">Save Wallet</button>
      <button id="autoConnectWalletBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Connect MetaMask">Connect MetaMask</button>
      <button id="claimTVMBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Claim TVM">Claim TVM</button>
    </section>

    <!-- Catch In -->
    <section id="catchInSection" class="section bg-white bg-opacity-10 p-4 rounded-lg">
      <label for="catchInBioCatch" class="text-lg">Receive Segments:</label><br>
      <input type="text" id="catchInBioCatch" class="input-field w-full p-2 rounded-lg" placeholder="Paste Bio-Catch" aria-label="Bio-Catch">
      <input type="number" id="catchInAmount" class="input-field w-full p-2 rounded-lg mt-2" placeholder="Amount (Segments)" aria-label="Amount">
      <button id="catchInBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Receive Segments">Catch In</button>
    </section>

    <!-- Catch Out -->
    <section id="catchOutSection" class="section bg-white bg-opacity-10 p-4 rounded-lg">
      <label for="receiverBioIBAN" class="text-lg">Send Segments:</label><br>
      <input type="text" id="receiverBioIBAN" class="input-field w-full p-2 rounded-lg" placeholder="Receiver Bio-IBAN" aria-label="Receiver Bio-IBAN">
      <input type="number" id="catchOutAmount" class="input-field w-full p-2 rounded-lg mt-2" placeholder="Amount (Segments)" aria-label="Amount">
      <div class="tooltip">
        <button id="catchOutBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Send Segments">Catch Out</button>
        <span class="tooltip-text">Large transfers (>10,000 segments) may take time. Confirm before sending.</span>
      </div>
      <button id="showBioCatchBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-2" aria-label="Show Bio-Catch">Show Bio-Catch</button>
    </section>

    <!-- Transactions -->
    <section class="section">
      <h3 class="text-xl font-bold">Transaction History</h3>
      <div class="flex flex-wrap gap-2 mt-2">
        <button id="exportBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg" aria-label="Export Transactions">Export Transactions</button>
        <button id="exportBackupBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg" aria-label="Backup Vault">Backup Vault</button>
        <button id="exportFriendlyBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg" aria-label="Friendly Backup">Friendly Backup</button>
        <button id="installA2HSBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg" aria-label="Install App">Install App</button>
        <button id="exportComplianceBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg" aria-label="Export Compliance Report">Compliance Report</button>
      </div>
      <label for="importVaultFileInput" class="mt-2">Import .vault:</label>
      <input type="file" id="importVaultFileInput" class="mt-2" accept=".vault" aria-label="Import Vault">
      <table id="transactionTable" class="mt-4">
        <thead>
          <tr>
            <th>Bio-IBAN</th>
            <th>Bio-Catch</th>
            <th>Proof</th>
            <th>Amount</th>
            <th>Date/Time</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="transactionBody"></tbody>
        <tfoot id="txEmptyState" class="hidden">
          <tr><td colspan="6">No transactions yet.</td></tr>
        </tfoot>
      </table>
      <div class="flex justify-between mt-2">
        <button id="txPrevBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hidden" aria-label="Previous Page">Previous</button>
        <button id="txNextBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hidden" aria-label="Next Page">Next</button>
      </div>
    </section>

    <!-- Exchange Rate Info -->
    <section id="p2pInfo" class="section text-sm">
      <p>Exchange Rate: 1 USD = 12 SHE = 1 TVM — Protocol Pegged. <a href="#" class="text-yellow-300 underline" onclick="openModal('whitepaperModal')">Learn More</a></p>
    </section>
  </main>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Footer -->
  <footer class="section mt-8">
    <p>By RR.R — for Humanity. © <span id="currentYear"></span></p>
    <script>document.getElementById('currentYear').textContent = new Date().getFullYear();</script>
  </footer>

  <!-- Main Script -->
  <script type="module" src="balance_chain_v3.js"></script>

  <!-- UI and Accessibility Scripts -->
  <script>
    // Modal Navigation
    function openModal(id) {
      document.querySelectorAll('.modal, .popup').forEach(m => m.style.display = 'none');
      const modal = document.getElementById(id);
      if (modal) {
        modal.style.display = 'flex';
        const focusEl = modal.querySelector('[tabindex="0"]');
        if (focusEl) setTimeout(() => focusEl.focus(), 130);
      }
      document.body.style.overflow = 'hidden';
    }
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    function modalNav(modalId, pageIdx) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      const pages = modal.querySelectorAll('.modal-onboarding-page');
      pages.forEach((p, i) => p.classList.toggle('hidden', i !== pageIdx));
      const nav = modal.querySelectorAll('.modal-nav button');
      nav.forEach((btn, i) => btn.classList.toggle('active', i === pageIdx));
    }

    // Accessibility: ESC and Click Outside
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal, .popup').forEach(m => m.style.display = 'none');
        document.body.style.overflow = '';
      }
    });
    document.querySelectorAll('.modal, .popup').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) {
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }
      });
    });

    // Onboarding and Backup Reminder
    function showOnboardingIfNeeded() {
      if (!localStorage.getItem('vaultOnboarded')) {
        openModal('onboardingModal');
        modalNav('onboardingModal', 0);
        localStorage.setItem('vaultOnboarded', 'yes');
      }
    }
    function showBackupReminder() {
      document.getElementById('onboardingTip').style.display = localStorage.getItem('vaultBackedUp') ? 'none' : '';
    }
    showOnboardingIfNeeded();
    showBackupReminder();

    // UTC Clock
    function updateUTCClock() {
      document.getElementById('utcTime').textContent = `UTC: ${new Date().toUTCString()}`;
    }
    setInterval(updateUTCClock, 1000);
    updateUTCClock();

    // Passphrase Modal Logic
    document.getElementById('enterVaultBtn').addEventListener('click', () => {
      const modal = document.getElementById('passModal');
      const title = document.getElementById('passModalTitle');
      const confirmLabel = document.getElementById('passModalConfirmLabel');
      const confirmInput = document.getElementById('passModalConfirmInput');
      title.textContent = localStorage.getItem('vaultOnboarded') ? 'Unlock Vault' : 'Create Vault';
      confirmLabel.classList.toggle('hidden', localStorage.getItem('vaultOnboarded'));
      confirmInput.classList.toggle('hidden', localStorage.getItem('vaultOnboarded'));
      modal.style.display = 'flex';
    });

    document.getElementById('passModalSaveBtn').addEventListener('click', () => window.safeHandler(async () => {
      const pin = document.getElementById('passModalInput').value;
      const confirm = document.getElementById('passModalConfirmInput').value;
      if (!pin || pin.length < 8) throw new Error('Passphrase must be ≥8 characters');
      if (!localStorage.getItem('vaultOnboarded')) {
        if (pin !== confirm) throw new Error('Passphrases do not match');
        await window.VaultService.onboard(pin);
      } else {
        await window.VaultService.unlock(pin);
      }
      closeModal('passModal');
      window.renderVaultUI();
    }));

    document.getElementById('passModalCancelBtn').addEventListener('click', () => closeModal('passModal'));

    // Override Transaction Table Rendering
    window.renderTransactions = function () {
      const v = window.VaultService.current;
      if (!v) return;
      const tbody = document.getElementById('transactionBody');
      const empty = document.getElementById('txEmptyState');
      const prev = document.getElementById('txPrevBtn');
      const next = document.getElementById('txNextBtn');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!v.transactionHistory.length) {
        empty.style.display = '';
        prev.style.display = 'none';
        next.style.display = 'none';
        return;
      }
      empty.style.display = 'none';
      const pageSize = 10;
      const start = window.transactionPage * pageSize;
      const end = start + pageSize;
      v.transactionHistory.slice(start, end).forEach(tx => {
        const proof = tx.bioCatch ? tx.bioCatch.slice(0, 8) + '...' : 'N/A';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${tx.type === 'cashback' ? `Bonus #${tx.bonusId}` : (tx.to === v.deviceKeyHashes[0] ? tx.from : tx.to).slice(0, 10) + '...'}</td>
          <td>${tx.bioCatch ? tx.bioCatch.slice(0, 8) + '...' : '—'}</td>
          <td>${proof}</td>
          <td>${tx.amount}</td>
          <td>${new Date(tx.timestamp * 1000).toLocaleString()}</td>
          <td>${tx.status}</td>
        `;
        tbody.appendChild(tr);
      });
      prev.style.display = window.transactionPage > 0 ? '' : 'none';
      next.style.display = end < v.transactionHistory.length ? '' : 'none';
    };
    window.transactionPage = 0;

    // Claim TVM Button
    document.getElementById('claimTVMBtn').addEventListener('click', () => window.safeHandler(async () => {
      if (!confirm('Claim available TVM tokens to your KYC’d wallet?')) return;
      await window.TokenService.claimTvmTokens();
      window.renderVaultUI();
      window.showToast('TVM tokens claimed successfully!');
    }));

    // Large Transfer Warning
    document.getElementById('catchOutAmount').addEventListener('input', e => {
      const amt = Number(e.target.value);
      if (amt > 10000) {
        window.showToast('Large transfers (>10,000 segments) may take time.', true);
      }
    });

    // Audit Peg Live Update
    document.getElementById('auditPegLive').innerHTML = `1 TVM = 12 SHE = 1 USD (Protocol-Pegged). Last Audit: ${new Date().toLocaleString()}`;
  </script>
</body>
</html>
